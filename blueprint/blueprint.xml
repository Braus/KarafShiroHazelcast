<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:camel="http://camel.apache.org/schema/blueprint"
           xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.3.0"
           xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 https://osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
           http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">

<!--    <cm:property-placeholder persistent-id="eu.abeel.platform.adapter.vako.ags.oracledb2ftp" update-strategy="reload">
        <cm:default-properties>
            <cm:property name="start.consuming.routing" value="false"/>
            <cm:property name="db.cron.consumer" value="20 * * ? * * *"/>
            <cm:property name="xsd.version" value="1.4.2"/>
            <cm:property name="search.days.in.past" value="14"/>
            <cm:property name="filestore.file" value=".adapter.vako.ags.oracledb2ftp.dat"/>
            <cm:property name="filestore.max.size" value="51200"/>
            <cm:property name="filestore.max.cached" value="5000"/>
            <cm:property name="file.archive.folder" value="data/file-archive/"/>
            <cm:property name="ftp.protocol" value="sftp"/>
            <cm:property name="ftp.host" value="vako.dotcombusiness.nl"/>
            <cm:property name="ftp.port" value="22"/>
            <cm:property name="ftp.encoding" value="utf-8"/>
            <cm:property name="ftp.dir" value="M1FtpTest"/>
            <cm:property name="ftp.username" value="GastonSchul"/>
            <cm:property name="ftp.password" value="do7JifJemlJJ"/>
            <cm:property name="proxy.host" value="10.1.7.60"/>
            <cm:property name="proxy.port" value="8080"/>
            <cm:property name="proxy.username" value="svc_proxy"/>
            <cm:property name="proxy.password" value="Pr0x!L0gin^4!778"/>
        </cm:default-properties>
    </cm:property-placeholder>

    <reference id="streamAgsPersistenceService" interface="eu.abeel.platform.facade.oracle.ags.api.spi.StreamAgsPersistenceService" availability="optional"/>

    <bean id="vakoProcessor" class="eu.abeel.platform.adapter.vako.ags.oracledb2ftp.service.VakoProcessor">
        <property name="streamAgsPersistenceService" ref="streamAgsPersistenceService"/>
        <property name="version" value="${xsd.version}"/>
        <property name="searchDaysIntoPast" value="${search.days.in.past}"/>
    </bean>

    <bean id="proxyHTTP" class="eu.abeel.platform.adapter.vako.ags.oracledb2ftp.service.ProxyHTTPFactory" factory-method="createProxyHTTP">
        <argument index="0" value="${proxy.host}"/>
        <argument index="1" value="${proxy.port}"/>
        <argument index="2" value="${proxy.username}"/>
        <argument index="3" value="${proxy.password}"/>
    </bean>

    <bean id="fileStore" class="org.apache.camel.processor.idempotent.FileIdempotentRepository">
        <property name="fileStore" value="data/store/${filestore.file}"/>
        <property name="maxFileStoreSize" value="${filestore.max.size}"/>
        <property name="cacheSize" value="${filestore.max.cached}"/>
    </bean>

    <camelContext id="platform-adapter-vako-ags-oracledb2ftp" xmlns="http://camel.apache.org/schema/blueprint">

        <dataFormats>
            <jaxb id="nctsSswReleaseRowContext" prettyPrint="true" contextPath="eu.abeel.platform.adapter.vako.ags.oracledb2ftp.api.generated"/>
        </dataFormats>

        <onException>
            <exception>java.lang.Throwable</exception>
            <handled>
                <simple>true</simple>
            </handled>
            <log loggingLevel="ERROR" message="File ${in.header.CamelFileName} produced an error: ${exchangeProperty.CamelExceptionCaught}" logName="eu.abeel.platform.adapter.vako.ags.oracledb2ftp"/>
        </onException>

        <route id="vakoDatabaseConsumer" autoStartup="{{start.consuming.routing}}">
            <from uri="quartz2://vako/agsdb2vako?cron={{db.cron.consumer}}"/>
            <log loggingLevel="DEBUG" message="TEST STARTED" logName="eu.abeel.platform.adapter.vako.ags.oracledb2ftp"/>
            <process ref="vakoProcessor"/>
            <split>
                <simple>${in.body}</simple>
                <to uri="direct:idempotency"/>
            </split>
        </route>

        <route id="vakoIdempotency">
            <from uri="direct:idempotency"/>
            <idempotentConsumer messageIdRepositoryRef="fileStore" removeOnFailure="true" skipDuplicate="false" eager="true" completionEager="false">
                <simple>${in.body.customs.mRN}</simple>
                <marshal>
                    <custom ref="nctsSswReleaseRowContext"/>
                </marshal>
                <choice>
                    <when>
                        <exchangeProperty>CamelDuplicateMessage</exchangeProperty>
                        <log loggingLevel="TRACE" message="Duplicate message!" logName="eu.abeel.platform.adapter.vako.ags.oracledb2ftp"/>
                    </when>
                    <otherwise>
                        <setHeader headerName="CamelFileName">
                            <simple>M1_${date:now:yyyyMMddHHmmss}${exchangeProperty.CamelSplitIndex}.xml</simple>
                        </setHeader>
                        <setProperty propertyName="VakoDomain">
                            <constant>Vako</constant>
                        </setProperty>
                        <to uri="direct:ftpProducer"/>
                    </otherwise>
                </choice>
            </idempotentConsumer>
        </route>

        <route id="vakoFtpProducer">
            <from uri="direct:ftpProducer"/>
            <to uri="file://{{file.archive.folder}}/vako"/>
            <to uri="{{ftp.protocol}}://{{ftp.username}}@{{ftp.host}}:{{ftp.port}}/{{ftp.dir}}?password={{ftp.password}}&amp;proxy=#proxyHTTP&amp;charset={{ftp.encoding}}&amp;disconnectOnBatchComplete=true"/>
        </route>

    </camelContext>-->

</blueprint>